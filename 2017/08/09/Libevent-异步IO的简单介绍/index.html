<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Libevent: 异步IO的简单介绍 | SeriouslyJoy</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Libevent: 异步IO的简单介绍</h1><a id="logo" href="/.">SeriouslyJoy</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Libevent: 异步IO的简单介绍</h1><div class="post-meta">Aug 9, 2017<span> | </span><span class="category"><a href="/categories/network/">网络编程</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="Libevent-异步IO的简单介绍"><a href="#Libevent-异步IO的简单介绍" class="headerlink" title="Libevent: 异步IO的简单介绍"></a>Libevent: 异步IO的简单介绍</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">These documents are Copyright (c) 2009-2012 by Nick Mathewson, and are made available under the Creative Commons Attribution-Noncommercial-Share Alike license, version 3.0. Future versions may be made available under a less restrictive license.</div><div class="line"></div><div class="line">Additionally, the source code examples in these documents are also licensed under the so-called &quot;3-Clause&quot; or &quot;Modified&quot; BSD license. See the license_bsd file distributed with these documents for the full terms.</div><div class="line"></div><div class="line">For the latest version of this document, see http://www.wangafu.net/~nickm/libevent-book/TOC.html</div><div class="line"></div><div class="line">To get the source for the latest version of this document, install git and run &quot;git clone git://github.com/nmathewson/libevent-book.git&quot;</div></pre></td></tr></table></figure>
<blockquote>
<p>原文地址： <a href="http://www.wangafu.net/~nickm/libevent-book/01_intro.html" target="_blank" rel="external">http://www.wangafu.net/~nickm/libevent-book/01_intro.html</a></p>
</blockquote>
<p>大部分初学者学习网络都是从阻塞IO调用开始的。一个IO调用如果是同步的，当我们调用它，它会阻塞直到操作完成，或者在尝试足够多次后你的网络栈放弃继续尝试。比如如果你用Tcp方式调用connect()操作，你的操作系统会发一个SYN包到目标主机端口。你的应用会阻塞在connect()直到你收到目标主机发来的SYN ACK包或者尝试连接多次后放弃继续连接。</p>
<p>下面有一个简单的客户端使用阻塞调用的例子。它尝试连接谷歌网站www.google.com, 并发送一段HTTP请求， 然后在终端打印对方的响应。</p>
<blockquote>
<p>例1： 一个简单的HTTP客户端</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line">/* For sockaddr_in */</div><div class="line">#include &lt;netinet/in.h&gt;</div><div class="line">/* For socket functions */</div><div class="line">#include &lt;sys/socket.h&gt;</div><div class="line">/* For gethostbyname */</div><div class="line">#include &lt;netdb.h&gt;</div><div class="line"></div><div class="line">#include &lt;unistd.h&gt;</div><div class="line">#include &lt;string.h&gt;</div><div class="line">#include &lt;stdio.h&gt;</div><div class="line"></div><div class="line">int main(int c, char **v)</div><div class="line">&#123;</div><div class="line">    const char query[] =</div><div class="line">        &quot;GET / HTTP/1.0\r\n&quot;</div><div class="line">        &quot;Host: www.google.com\r\n&quot;</div><div class="line">        &quot;\r\n&quot;;</div><div class="line">    const char hostname[] = &quot;www.google.com&quot;;</div><div class="line">    struct sockaddr_in sin;</div><div class="line">    struct hostent *h;</div><div class="line">    const char *cp;</div><div class="line">    int fd;</div><div class="line">    ssize_t n_written, remaining;</div><div class="line">    char buf[1024];</div><div class="line"></div><div class="line">    /* Look up the IP address for the hostname.   Watch out; this isn&apos;t</div><div class="line">       threadsafe on most platforms. */</div><div class="line">    h = gethostbyname(hostname);</div><div class="line">    if (!h) &#123;</div><div class="line">        fprintf(stderr, &quot;Couldn&apos;t lookup %s: %s&quot;, hostname, hstrerror(h_errno));</div><div class="line">        return 1;</div><div class="line">    &#125;</div><div class="line">    if (h-&gt;h_addrtype != AF_INET) &#123;</div><div class="line">        fprintf(stderr, &quot;No ipv6 support, sorry.&quot;);</div><div class="line">        return 1;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* Allocate a new socket */</div><div class="line">    fd = socket(AF_INET, SOCK_STREAM, 0);</div><div class="line">    if (fd &lt; 0) &#123;</div><div class="line">        perror(&quot;socket&quot;);</div><div class="line">        return 1;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* Connect to the remote host. */</div><div class="line">    sin.sin_family = AF_INET;</div><div class="line">    sin.sin_port = htons(80);</div><div class="line">    sin.sin_addr = *(struct in_addr*)h-&gt;h_addr;</div><div class="line">    if (connect(fd, (struct sockaddr*) &amp;sin, sizeof(sin))) &#123;</div><div class="line">        perror(&quot;connect&quot;);</div><div class="line">        close(fd);</div><div class="line">        return 1;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* Write the query. */</div><div class="line">    /* XXX Can send succeed partially? */</div><div class="line">    cp = query;</div><div class="line">    remaining = strlen(query);</div><div class="line">    while (remaining) &#123;</div><div class="line">      n_written = send(fd, cp, remaining, 0);</div><div class="line">      if (n_written &lt;= 0) &#123;</div><div class="line">        perror(&quot;send&quot;);</div><div class="line">        return 1;</div><div class="line">      &#125;</div><div class="line">      remaining -= n_written;</div><div class="line">      cp += n_written;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* Get an answer back. */</div><div class="line">    while (1) &#123;</div><div class="line">        ssize_t result = recv(fd, buf, sizeof(buf), 0);</div><div class="line">        if (result == 0) &#123;</div><div class="line">            break;</div><div class="line">        &#125; else if (result &lt; 0) &#123;</div><div class="line">            perror(&quot;recv&quot;);</div><div class="line">            close(fd);</div><div class="line">            return 1;</div><div class="line">        &#125;</div><div class="line">        fwrite(buf, 1, result, stdout);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    close(fd);</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码中所以的网络API调用都是阻塞的。<code>gethostbyname</code>调用会阻塞直到执行成功或者解析<code>www.google.com</code>失败。<code>connect</code>调用会阻塞直到连上。<code>recv</code>调用会阻塞直到接收到足够的数据或者连接关闭。<code>send</code>调用会阻塞直到向内核写缓存里写了部分数据。</p>
<p>这样看来，使用阻塞IO也未尝不可。如果你的程序在调用阻塞调用的时候不需要去处理其他的事情的话，阻塞IO很适合。但是如果你期望你的程序能同时处理多个连接，具体一点就是假如我们前面的例子中，你需要从2个连接中读取数据，并且你不清楚哪个连接会先有数据到来。这样的话阻塞IO调用就不见得合适了。</p>
<blockquote>
<p>一个反面例子：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">/* This won&apos;t work. */</div><div class="line">char buf[1024];</div><div class="line">int i, n;</div><div class="line">while (i_still_want_to_read()) &#123;</div><div class="line">    for (i=0; i&lt;n_sockets; ++i) &#123;</div><div class="line">        n = recv(fd[i], buf, sizeof(buf), 0);</div><div class="line">        if (n==0)</div><div class="line">            handle_close(fd[i]);</div><div class="line">        else if (n&lt;0)</div><div class="line">            handle_error(fd[i], errno);</div><div class="line">        else</div><div class="line">            handle_input(fd[i], buf, n);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果是fd[2]中先有数据到来，你的程序并不会尝试先去fd[2]中读取数据，而等待程序从fd[0]和fd[1]中读取到数据并完成读取后才会去读fd[2]中的数据。</p>
<p>有人会想用多线程或者多进程的方式去解决这个问题。一种简单的方式是使用单独的进程或者线程去处理每个独立连接，相当于每个连接都需要一个线程或者进程。这样的话单个连接的阻塞调用不会阻塞别的连接的线程或进程。</p>
<p>下面是另一个例子，这是一个简单的服务器，监听40713端口上tcp连接，按行读取输入，并将输入用<a href="https://zh.wikipedia.org/wiki/ROT13" target="_blank" rel="external">ROT13</a>加密后返回。例子使用Unix <code>fork()</code> 调用来为每个连接创建一个进程。</p>
<blockquote>
<p>Example: Forking ROT13 server</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div></pre></td><td class="code"><pre><div class="line">/* For sockaddr_in */</div><div class="line">#include &lt;netinet/in.h&gt;</div><div class="line">/* For socket functions */</div><div class="line">#include &lt;sys/socket.h&gt;</div><div class="line"></div><div class="line">#include &lt;unistd.h&gt;</div><div class="line">#include &lt;string.h&gt;</div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;stdlib.h&gt;</div><div class="line"></div><div class="line">#define MAX_LINE 16384</div><div class="line"></div><div class="line">char</div><div class="line">rot13_char(char c)</div><div class="line">&#123;</div><div class="line">    /* We don&apos;t want to use isalpha here; setting the locale would change</div><div class="line">     * which characters are considered alphabetical. */</div><div class="line">    if ((c &gt;= &apos;a&apos; &amp;&amp; c &lt;= &apos;m&apos;) || (c &gt;= &apos;A&apos; &amp;&amp; c &lt;= &apos;M&apos;))</div><div class="line">        return c + 13;</div><div class="line">    else if ((c &gt;= &apos;n&apos; &amp;&amp; c &lt;= &apos;z&apos;) || (c &gt;= &apos;N&apos; &amp;&amp; c &lt;= &apos;Z&apos;))</div><div class="line">        return c - 13;</div><div class="line">    else</div><div class="line">        return c;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void</div><div class="line">child(int fd)</div><div class="line">&#123;</div><div class="line">    char outbuf[MAX_LINE+1];</div><div class="line">    size_t outbuf_used = 0;</div><div class="line">    ssize_t result;</div><div class="line"></div><div class="line">    while (1) &#123;</div><div class="line">        char ch;</div><div class="line">        result = recv(fd, &amp;ch, 1, 0);</div><div class="line">        if (result == 0) &#123;</div><div class="line">            break;</div><div class="line">        &#125; else if (result == -1) &#123;</div><div class="line">            perror(&quot;read&quot;);</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        /* We do this test to keep the user from overflowing the buffer. */</div><div class="line">        if (outbuf_used &lt; sizeof(outbuf)) &#123;</div><div class="line">            outbuf[outbuf_used++] = rot13_char(ch);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (ch == &apos;\n&apos;) &#123;</div><div class="line">            send(fd, outbuf, outbuf_used, 0);</div><div class="line">            outbuf_used = 0;</div><div class="line">            continue;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void</div><div class="line">run(void)</div><div class="line">&#123;</div><div class="line">    int listener;</div><div class="line">    struct sockaddr_in sin;</div><div class="line"></div><div class="line">    sin.sin_family = AF_INET;</div><div class="line">    sin.sin_addr.s_addr = 0;</div><div class="line">    sin.sin_port = htons(40713);</div><div class="line"></div><div class="line">    listener = socket(AF_INET, SOCK_STREAM, 0);</div><div class="line"></div><div class="line">#ifndef WIN32</div><div class="line">    &#123;</div><div class="line">        int one = 1;</div><div class="line">        setsockopt(listener, SOL_SOCKET, SO_REUSEADDR, &amp;one, sizeof(one));</div><div class="line">    &#125;</div><div class="line">#endif</div><div class="line"></div><div class="line">    if (bind(listener, (struct sockaddr*)&amp;sin, sizeof(sin)) &lt; 0) &#123;</div><div class="line">        perror(&quot;bind&quot;);</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (listen(listener, 16)&lt;0) &#123;</div><div class="line">        perror(&quot;listen&quot;);</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    while (1) &#123;</div><div class="line">        struct sockaddr_storage ss;</div><div class="line">        socklen_t slen = sizeof(ss);</div><div class="line">        int fd = accept(listener, (struct sockaddr*)&amp;ss, &amp;slen);</div><div class="line">        if (fd &lt; 0) &#123;</div><div class="line">            perror(&quot;accept&quot;);</div><div class="line">        &#125; else &#123;</div><div class="line">            if (fork() == 0) &#123;</div><div class="line">                child(fd);</div><div class="line">                exit(0);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">int</div><div class="line">main(int c, char **v)</div><div class="line">&#123;</div><div class="line">    run();</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以我们有没有更完美的解决方案同时处理多个连接？ 现在我能否现在停下写这篇文章而去做一些其他的工作？不大可能。首先，创建进程（甚至创建线程）在某些操作系统上代价很高。实际上你可能会想到用进程池来取代实时创建新进程。但事实上，进程并不能增加到像你希望的那样多。如果你的程序需要在同一时刻处理成千上万的连接，处理成千上万个进程对于同时只能处理几个进程的cpu来说是很低效的。</p>
<p>但是如果多进程(线程)不是处理很多连接的解决方案的话，那应该怎么做呢？在Unix编程中，你可以让socket工作在非阻塞状态下，通过如下设置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fcntl(fd, F_SETFL, O_NONBLOCK);</div></pre></td></tr></table></figure>
<p>fd参数是socket的<a href="https://zh.wikipedia.org/wiki/%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6" target="_blank" rel="external">文件描述符</a>。</p>
<p>只要你装文件描述符设置成非阻塞，之后你在该文件描述符上进去的网络调用都将立即完成并且返回一个特殊的错误码来表明“没有任何可处理的事，请重试”。所以上面2个socket的例子可能会写成下面这样：</p>
<blockquote>
<p>另一个不好的例子：busy-polling all sockets</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">/* This will work, but the performance will be unforgivably bad. */</div><div class="line">int i, n;</div><div class="line">char buf[1024];</div><div class="line">for (i=0; i &lt; n_sockets; ++i)</div><div class="line">    fcntl(fd[i], F_SETFL, O_NONBLOCK);</div><div class="line"></div><div class="line">while (i_still_want_to_read()) &#123;</div><div class="line">    for (i=0; i &lt; n_sockets; ++i) &#123;</div><div class="line">        n = recv(fd[i], buf, sizeof(buf), 0);</div><div class="line">        if (n == 0) &#123;</div><div class="line">            handle_close(fd[i]);</div><div class="line">        &#125; else if (n &lt; 0) &#123;</div><div class="line">            if (errno == EAGAIN)</div><div class="line">                 ; /* The kernel didn&apos;t have any data for us to read. */</div><div class="line">            else</div><div class="line">                 handle_error(fd[i], errno);</div><div class="line">         &#125; else &#123;</div><div class="line">            handle_input(fd[i], buf, n);</div><div class="line">         &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在我们用了非阻塞socket, 上面的代码可以工作，但是很勉强。性能非常的槽糕。原因有2点，首先如果当前所有的连接上没有任何可以读的数据，这段代码就会无限循环空转，占据着cpu时间。其次如果你想用这种方法尝试处理多于一个或者两个的连接，你需要为每个连接进行系统调用，不管是否有数据。所以我们需要做的就是告诉内核 “等待直到有一个或者多个socket准备好可读数据，并且告诉我哪些socket准备好了”。</p>
<p>这个问题最古老的解决方案就是使用<code>select()</code>，这种方案现在仍然有人在用。<code>select()</code>调用需要3个文件描述符数组参数(用字节数组表示)，一个用来存可读文件描述符，一个存可写，一个存“异常”。调用会阻塞直到有一个socket准备好，然后会改动这3个数组的内容。</p>
<p>下面是一个简单使用<code>select()</code>的例子。</p>
<blockquote>
<p>Example: Using select</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">/* If you only have a couple dozen fds, this version won&apos;t be awful */</div><div class="line">fd_set readset;</div><div class="line">int i, n;</div><div class="line">char buf[1024];</div><div class="line"></div><div class="line">while (i_still_want_to_read()) &#123;</div><div class="line">    int maxfd = -1;</div><div class="line">    FD_ZERO(&amp;readset);</div><div class="line"></div><div class="line">    /* Add all of the interesting fds to readset */</div><div class="line">    for (i=0; i &lt; n_sockets; ++i) &#123;</div><div class="line">         if (fd[i]&gt;maxfd) maxfd = fd[i];</div><div class="line">         FD_SET(fd[i], &amp;readset);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* Wait until one or more fds are ready to read */</div><div class="line">    select(maxfd+1, &amp;readset, NULL, NULL, NULL);</div><div class="line"></div><div class="line">    /* Process all of the fds that are still set in readset */</div><div class="line">    for (i=0; i &lt; n_sockets; ++i) &#123;</div><div class="line">        if (FD_ISSET(fd[i], &amp;readset)) &#123;</div><div class="line">            n = recv(fd[i], buf, sizeof(buf), 0);</div><div class="line">            if (n == 0) &#123;</div><div class="line">                handle_close(fd[i]);</div><div class="line">            &#125; else if (n &lt; 0) &#123;</div><div class="line">                if (errno == EAGAIN)</div><div class="line">                     ; /* The kernel didn&apos;t have any data for us to read. */</div><div class="line">                else</div><div class="line">                     handle_error(fd[i], errno);</div><div class="line">             &#125; else &#123;</div><div class="line">                handle_input(fd[i], buf, n);</div><div class="line">             &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面是重写的ROT13加密回写服务器。</p>
<blockquote>
<p>Example: select()-based ROT13 server</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div></pre></td><td class="code"><pre><div class="line">/* For sockaddr_in */</div><div class="line">#include &lt;netinet/in.h&gt;</div><div class="line">/* For socket functions */</div><div class="line">#include &lt;sys/socket.h&gt;</div><div class="line">/* For fcntl */</div><div class="line">#include &lt;fcntl.h&gt;</div><div class="line">/* for select */</div><div class="line">#include &lt;sys/select.h&gt;</div><div class="line"></div><div class="line">#include &lt;assert.h&gt;</div><div class="line">#include &lt;unistd.h&gt;</div><div class="line">#include &lt;string.h&gt;</div><div class="line">#include &lt;stdlib.h&gt;</div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;errno.h&gt;</div><div class="line"></div><div class="line">#define MAX_LINE 16384</div><div class="line"></div><div class="line">char</div><div class="line">rot13_char(char c)</div><div class="line">&#123;</div><div class="line">    /* We don&apos;t want to use isalpha here; setting the locale would change</div><div class="line">     * which characters are considered alphabetical. */</div><div class="line">    if ((c &gt;= &apos;a&apos; &amp;&amp; c &lt;= &apos;m&apos;) || (c &gt;= &apos;A&apos; &amp;&amp; c &lt;= &apos;M&apos;))</div><div class="line">        return c + 13;</div><div class="line">    else if ((c &gt;= &apos;n&apos; &amp;&amp; c &lt;= &apos;z&apos;) || (c &gt;= &apos;N&apos; &amp;&amp; c &lt;= &apos;Z&apos;))</div><div class="line">        return c - 13;</div><div class="line">    else</div><div class="line">        return c;</div><div class="line">&#125;</div><div class="line"></div><div class="line">struct fd_state &#123;</div><div class="line">    char buffer[MAX_LINE];</div><div class="line">    size_t buffer_used;</div><div class="line"></div><div class="line">    int writing;</div><div class="line">    size_t n_written;</div><div class="line">    size_t write_upto;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct fd_state *</div><div class="line">alloc_fd_state(void)</div><div class="line">&#123;</div><div class="line">    struct fd_state *state = malloc(sizeof(struct fd_state));</div><div class="line">    if (!state)</div><div class="line">        return NULL;</div><div class="line">    state-&gt;buffer_used = state-&gt;n_written = state-&gt;writing =</div><div class="line">        state-&gt;write_upto = 0;</div><div class="line">    return state;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void</div><div class="line">free_fd_state(struct fd_state *state)</div><div class="line">&#123;</div><div class="line">    free(state);</div><div class="line">&#125;</div><div class="line"></div><div class="line">void</div><div class="line">make_nonblocking(int fd)</div><div class="line">&#123;</div><div class="line">    fcntl(fd, F_SETFL, O_NONBLOCK);</div><div class="line">&#125;</div><div class="line"></div><div class="line">int</div><div class="line">do_read(int fd, struct fd_state *state)</div><div class="line">&#123;</div><div class="line">    char buf[1024];</div><div class="line">    int i;</div><div class="line">    ssize_t result;</div><div class="line">    while (1) &#123;</div><div class="line">        result = recv(fd, buf, sizeof(buf), 0);</div><div class="line">        if (result &lt;= 0)</div><div class="line">            break;</div><div class="line"></div><div class="line">        for (i=0; i &lt; result; ++i)  &#123;</div><div class="line">            if (state-&gt;buffer_used &lt; sizeof(state-&gt;buffer))</div><div class="line">                state-&gt;buffer[state-&gt;buffer_used++] = rot13_char(buf[i]);</div><div class="line">            if (buf[i] == &apos;\n&apos;) &#123;</div><div class="line">                state-&gt;writing = 1;</div><div class="line">                state-&gt;write_upto = state-&gt;buffer_used;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (result == 0) &#123;</div><div class="line">        return 1;</div><div class="line">    &#125; else if (result &lt; 0) &#123;</div><div class="line">        if (errno == EAGAIN)</div><div class="line">            return 0;</div><div class="line">        return -1;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return 0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">int</div><div class="line">do_write(int fd, struct fd_state *state)</div><div class="line">&#123;</div><div class="line">    while (state-&gt;n_written &lt; state-&gt;write_upto) &#123;</div><div class="line">        ssize_t result = send(fd, state-&gt;buffer + state-&gt;n_written,</div><div class="line">                              state-&gt;write_upto - state-&gt;n_written, 0);</div><div class="line">        if (result &lt; 0) &#123;</div><div class="line">            if (errno == EAGAIN)</div><div class="line">                return 0;</div><div class="line">            return -1;</div><div class="line">        &#125;</div><div class="line">        assert(result != 0);</div><div class="line"></div><div class="line">        state-&gt;n_written += result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (state-&gt;n_written == state-&gt;buffer_used)</div><div class="line">        state-&gt;n_written = state-&gt;write_upto = state-&gt;buffer_used = 0;</div><div class="line"></div><div class="line">    state-&gt;writing = 0;</div><div class="line"></div><div class="line">    return 0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void</div><div class="line">run(void)</div><div class="line">&#123;</div><div class="line">    int listener;</div><div class="line">    struct fd_state *state[FD_SETSIZE];</div><div class="line">    struct sockaddr_in sin;</div><div class="line">    int i, maxfd;</div><div class="line">    fd_set readset, writeset, exset;</div><div class="line"></div><div class="line">    sin.sin_family = AF_INET;</div><div class="line">    sin.sin_addr.s_addr = 0;</div><div class="line">    sin.sin_port = htons(40713);</div><div class="line"></div><div class="line">    for (i = 0; i &lt; FD_SETSIZE; ++i)</div><div class="line">        state[i] = NULL;</div><div class="line"></div><div class="line">    listener = socket(AF_INET, SOCK_STREAM, 0);</div><div class="line">    make_nonblocking(listener);</div><div class="line"></div><div class="line">#ifndef WIN32</div><div class="line">    &#123;</div><div class="line">        int one = 1;</div><div class="line">        setsockopt(listener, SOL_SOCKET, SO_REUSEADDR, &amp;one, sizeof(one));</div><div class="line">    &#125;</div><div class="line">#endif</div><div class="line"></div><div class="line">    if (bind(listener, (struct sockaddr*)&amp;sin, sizeof(sin)) &lt; 0) &#123;</div><div class="line">        perror(&quot;bind&quot;);</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (listen(listener, 16)&lt;0) &#123;</div><div class="line">        perror(&quot;listen&quot;);</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    FD_ZERO(&amp;readset);</div><div class="line">    FD_ZERO(&amp;writeset);</div><div class="line">    FD_ZERO(&amp;exset);</div><div class="line"></div><div class="line">    while (1) &#123;</div><div class="line">        maxfd = listener;</div><div class="line"></div><div class="line">        FD_ZERO(&amp;readset);</div><div class="line">        FD_ZERO(&amp;writeset);</div><div class="line">        FD_ZERO(&amp;exset);</div><div class="line"></div><div class="line">        FD_SET(listener, &amp;readset);</div><div class="line"></div><div class="line">        for (i=0; i &lt; FD_SETSIZE; ++i) &#123;</div><div class="line">            if (state[i]) &#123;</div><div class="line">                if (i &gt; maxfd)</div><div class="line">                    maxfd = i;</div><div class="line">                FD_SET(i, &amp;readset);</div><div class="line">                if (state[i]-&gt;writing) &#123;</div><div class="line">                    FD_SET(i, &amp;writeset);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (select(maxfd+1, &amp;readset, &amp;writeset, &amp;exset, NULL) &lt; 0) &#123;</div><div class="line">            perror(&quot;select&quot;);</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (FD_ISSET(listener, &amp;readset)) &#123;</div><div class="line">            struct sockaddr_storage ss;</div><div class="line">            socklen_t slen = sizeof(ss);</div><div class="line">            int fd = accept(listener, (struct sockaddr*)&amp;ss, &amp;slen);</div><div class="line">            if (fd &lt; 0) &#123;</div><div class="line">                perror(&quot;accept&quot;);</div><div class="line">            &#125; else if (fd &gt; FD_SETSIZE) &#123;</div><div class="line">                close(fd);</div><div class="line">            &#125; else &#123;</div><div class="line">                make_nonblocking(fd);</div><div class="line">                state[fd] = alloc_fd_state();</div><div class="line">                assert(state[fd]);/*XXX*/</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        for (i=0; i &lt; maxfd+1; ++i) &#123;</div><div class="line">            int r = 0;</div><div class="line">            if (i == listener)</div><div class="line">                continue;</div><div class="line"></div><div class="line">            if (FD_ISSET(i, &amp;readset)) &#123;</div><div class="line">                r = do_read(i, state[i]);</div><div class="line">            &#125;</div><div class="line">            if (r == 0 &amp;&amp; FD_ISSET(i, &amp;writeset)) &#123;</div><div class="line">                r = do_write(i, state[i]);</div><div class="line">            &#125;</div><div class="line">            if (r) &#123;</div><div class="line">                free_fd_state(state[i]);</div><div class="line">                state[i] = NULL;</div><div class="line">                close(i);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">int</div><div class="line">main(int c, char **v)</div><div class="line">&#123;</div><div class="line">    setvbuf(stdout, NULL, _IONBF, 0);</div><div class="line"></div><div class="line">    run();</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>未完待续。。。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://45.32.8.34/2017/08/09/Libevent-异步IO的简单介绍/" data-id="cjd9wwhef00015zxus2swzad1" class="article-share-link">分享</a><div class="tags"><a href="/tags/Libevent/">Libevent</a></div><div class="post-nav"><a href="/2017/08/30/UTF8字符编码的组成/" class="pre">UTF8字符编码的组成</a><a href="/2017/08/05/skynet中cservice-c服务的实现/" class="next">skynet中cservice c服务的实现</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://45.32.8.34"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/libevent/">Libevent</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/">杂项</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/framework/">框架</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/program-language/">编程语言</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/network/">网络编程</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Golang/" style="font-size: 15px;">Golang</a> <a href="/tags/Libevent/" style="font-size: 15px;">Libevent</a> <a href="/tags/ansible/" style="font-size: 15px;">ansible</a> <a href="/tags/skynet/" style="font-size: 15px;">skynet</a> <a href="/tags/Database/" style="font-size: 15px;">Database</a> <a href="/tags/c-11/" style="font-size: 15px;">c++11</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/02/05/新项目手游服务端设计-数据存储/">新项目手游服务端设计-数据存储</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/02/02/GO内存池实现/">GO内存池实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/25/写ansible-playbook脚本批量取回服务器上的文件/">写ansible playbook脚本批量取回服务器上的文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/26/Libevent手册-使用events/">Libevent手册-使用events</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/29/未使用c-11的时候，空指针使用NULL或0可能带来的问题之一/">未使用c++11的时候，空指针使用NULL或0可能带来的问题之一</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/30/UTF8字符编码的组成/">UTF8字符编码的组成</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/09/Libevent-异步IO的简单介绍/">Libevent: 异步IO的简单介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/05/skynet中cservice-c服务的实现/">skynet中cservice c服务的实现</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">SeriouslyJoy.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>